<div>
    <div class="page-header">Competency Question Generator</div>

    <div class="activate-config-container">
        <button mat-raised-button (click)="showActivateConfigDialog()"
            matTooltip="Activate the configuration of a KG to use in this task from the preconfigured ones."
            matTooltipPosition="above">
            <mat-icon>check_circle</mat-icon>
            Activate Another Configuration
        </button>
    </div>

    <form class="form" [formGroup]="formGroup">
        <mat-form-field class="full-width" matTooltip="KG textual description (used in prompts)"
            matTooltipPosition="above">
            <mat-label>KG Description</mat-label>
            <textarea rows="10" matInput formControlName="kg_description"></textarea>
        </mat-form-field>

        <mat-form-field class="full-width"
            matTooltip="KG textual schema (used in prompts). E.g. the list of the used ontologies. Can be prefilled using the sample schema button."
            matTooltipPosition="above">
            <mat-label>KG Schema</mat-label>
            <textarea rows="10" matInput formControlName="kg_schema"></textarea>
        </mat-form-field>

        <mat-form-field class="full-width"
            matTooltip="Optional field to add any context to the model. E.g. a textual abstract of the paper presenting the KG."
            matTooltipPosition="above">
            <mat-label>Additional Context</mat-label>
            <textarea rows="10" matInput formControlName="additional_context"></textarea>
        </mat-form-field>

        <mat-form-field class="full-width" matTooltip="The URI of the endpoint where to extract the KG schema"
            matTooltipPosition="above">
            <mat-label>Context Endpoint URI</mat-label>
            <input matInput formControlName="endpoint">
            @if (formGroup.get("endpoint")?.hasError('pattern')) {
            <mat-error>Please enter a valid Context Endpoint URI address</mat-error>
            }
            @if (formGroup.get("endpoint")?.hasError('required')) {
            <mat-error>Context Endpoint URI is <strong>required</strong></mat-error>
            }
        </mat-form-field>


        <div class="form-actions">
            <div class="model-container">
                <mat-form-field matTooltip="The model to be used to generate the competency questions"
                    matTooltipPosition="above">
                    <mat-label>Model</mat-label>
                    <mat-select formControlName="model_config_id" name="llm-model">
                        @for (item of availableSeq2SeqModels; track item) {
                        <mat-option [value]="item.configName">{{item.configName}}</mat-option>
                        }
                    </mat-select>
                </mat-form-field>
            </div>

            <mat-form-field matTooltip="The number of questions to be generated by the model"
                matTooltipPosition="above">
                <mat-label># Questions</mat-label>
                <input matInput type="number" min="1" max="100" formControlName="number_of_questions">
                @if (formGroup.get("number_of_questions")?.hasError('min')
                || formGroup.get("number_of_questions")?.hasError('max')) {
                <mat-error>Question Number Must be [1-100] </mat-error>
                }
                @if (formGroup.get("number_of_questions")?.hasError('required')) {
                <mat-error># Questions is <strong>required</strong></mat-error>
                }
            </mat-form-field>

            <mat-slide-toggle formControlName="enforceStructuredOutput"
                matTooltip="Wheter to enforce the model to generate a structured output or not. Required to import the generated CQs to the SPARQL query generation and executor phase."
                matTooltipPosition="above">
                Enforce Structured Output
            </mat-slide-toggle>

            <button mat-raised-button (click)="generateQuestionWithLLM()" matTooltip="Start the generation process"
                matTooltipPosition="above">
                <mat-icon>create</mat-icon>
                Generate Questions
            </button>
            <button mat-raised-button (click)="extractKGSchema()"
                matTooltip="Start the process of extracting the KG schema from the indicated endpoint URI. This will use the void.ttl file to extract the used ontologies and descriptions."
                matTooltipPosition="above"
                [disabled]="!formGroup.get('endpoint')?.valid || !formGroup.get('endpoint')?.value">
                <mat-icon>space_bar</mat-icon>
                Extract KG Schema
            </button>
            <button mat-raised-button class="warning" (click)="reset()" matTooltip="Reset all the fields"
                matTooltipPosition="above">
                <mat-icon>restore</mat-icon>
                Reset
            </button>
        </div>
    </form>


    @if (loading) {
    <div class="loading-message">Loading...</div>
    }
    @if (error) {
    <div class="error-message">{{ error }}</div>
    }

    @if (errorLLMAnswer) {
    <div class="error-message">Error: {{ errorLLMAnswer | json }}</div>
    }

    @if (llmAnswer ) {
    <h2>Generate Question Task</h2>
    <div>
        <markdown [data]="llmAnswer" lineNumbers clipboard></markdown>
    </div>
    }
    <div class="download-buttons">
        @if (workflowDone){
        <button mat-raised-button (click)="downloadResults()" matTooltip="Download the generated result as a plain text"
            matTooltipPosition="above">
            <mat-icon>save_alt</mat-icon>
            Download dump answer
        </button>
        }
        @if (this.competencyQuestions.length != 0) {
        <button mat-raised-button (click)="downloadStructuredResults()"
            matTooltip="Extract the generated competency questions and download them as a JSON file"
            matTooltipPosition="above">
            <mat-icon>save_alt</mat-icon>
            Extract and Download JSON
        </button>
        <button mat-raised-button (click)="addQuestionsToCookies()"
            matTooltip="Save the generated competency question in a cookie and start answering them using the GenÂ²KGBot workflow."
            matTooltipPosition="above">
            <mat-icon>bookmark</mat-icon>
            Save to cookie and Answer
        </button>
        }
    </div>
</div>